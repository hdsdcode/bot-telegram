Na quest√£o "Idiomas" preciso que implemente:

Na "Situa√ß√£o:"
Se for "S" para "Conclu√≠do", ent√£o, "Informe o ano de conclus√£o do Curso?"
Se for "C" para "Cursando", ent√£o, "Cursando", tanto para op√ß√µes 1, 2 e 3


Estou fazendo um projeto MVP para institui√ß√£o carente sem fins lucrativos, √© um curriculo utilizando python e o telegram poderia me ajudar
eu ja tenho um c√≥digo, preciso que me ajude
Esse que vou te enviar agora √© o c√≥digo 1, logo em seguida vou te enviar o c√≥digo 2
Vou te falar o que eu preciso ok

O c√≥digo 2 n√£o tem a √∫ltima pergunta que seria "Idiomas", preciso que adicione "Idiomas" igual com a mesma l√≥gica que esta no c√≥digo 1 ok?
Vou te passar o c√≥digo 1 para voc√™ analisar a quest√£o "Idiomas" ok?

Esta assim, preciso que implemente a sua l√≥gica que esta correta
 "Nome da √∫ltima empresa trabalhada:"
 "Nome da pen√∫ltima empresa trabalhada:"
 
 Quero que o bot pergunte: Quantas empresas voc√™ ja trabalhou? (0, 1, 2)
 =======================================================================================================================================================================
 
 # ACERTAR ESSA PARTE #
 Preciso que fa√ßa a seguinte altera√ß√£o, na pergunta abaixo:
 Na pergunta: "Voc√™ concluiu o Ensino M√©dio? Digite "S" para "Sim" ou "N" para "N√£o:
 Se a resposta for "N" ent√£o pule as "Pergunta 1" e "Pergunta 2" ja pule direto sem passar pelas perguntas abaixo, pois s√≥ pode passar por essas etapas 
 quem "Concluiu o Ensino M√©dio
 
 "Pergunta 1"
 "Quantas gradua√ß√µes voc√™ possui? (Digite 0 para pular):
 
 "Pergunta 2"
 "Quantas P√≥s-gradua√ß√µes voc√™ possui? (Digite 0 para pular):
 
 =========================================================================================================================================================================
 Ap√≥s essa pergunta o bot travou aqui e n√£o gerou o curr√≠culo ao digitar S
 üìö Liste seus cursos adicionais separados por v√≠rgula (Ex: Java, JavaScript, Excel):
  √ìtimo! Coletamos todas as informa√ß√µes. Deseja gerar o curr√≠culo em PDF? (S/N)
    ‚ö†Ô∏è Houve um erro ao gerar o curr√≠culo. Tente novamente ou verifique as informa√ß√µes fornecidas. Erro: expected str, bytes or os.PathLike object, not BytesIO
 
 FALTA ESTA 
  √ìtimo! Seu curr√≠culo est√° pronto. Deseja gerar o PDF? (S/N)
 
 ALTERAR ESSA
 "Digite seu estado civil (Ex: Solteiro, Casado):
 
 
 # AQUI FOI ACERTADO, MA O C√ìDIGO ESTA TRAVANDO EM GERAR O CURR√çCULO
 ‚úÖ √ìtimo! Coletamos todas as informa√ß√µes. Deseja gerar o curr√≠culo em PDF? (S/N)
 
 from telegram import Update
from telegram.ext import (
    ApplicationBuilder, CommandHandler, MessageHandler,
    filters, ContextTypes, ConversationHandler
)
from fpdf import FPDF
import io
import logging
import re

# --- Configura√ß√£o do Logger ---
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# --- Constantes para Estados da Conversa ---
(
    ESCOLHA, NOME, IDADE, ESTADO_CIVIL, TELEFONE, EMAIL,
    FORMA_2GRAU, ANO_2GRAU,

    # Estados gen√©ricos para Forma√ß√£o Acad√™mica
    ASK_QTD_GRAD, ASK_FACULDADE, ASK_CURSO, ASK_SITUACAO, ASK_ANO_GRAD,
    ASK_QTD_POS, ASK_POS_FACULDADE, ASK_POS_CURSO, ASK_POS_SITUACAO, ASK_POS_ANO,
    ADD_ACADEMIC_ITEM,

    # Estados gen√©ricos para Experi√™ncia Profissional
    TIPO_CONTRATO, # NOVO ESTADO
    EMPRESA, CARGO, ADM, DEM, ATIVIDADES, RESULTADOS, ADD_EMP, 
    MEI_TRABALHOS, # NOVO ESTADO PARA MEI

    # Estados gen√©ricos para Idiomas
    IDIOMAS_SIM, ASK_IDIOMA_INST, ASK_IDIOMA_NOME, ASK_IDIOMA_NIVEL, ASK_IDIOMA_INI, ASK_IDIOMA_FIM,
    ADD_IDIOMA,

    CURSOS, REINICIAR, CANCEL
) = range(38) # O n√∫mero de estados est√° correto para 37

# --- Valida√ß√µes ---
def validar_texto(texto, min_palavras=2):
    return len(texto.strip().split()) >= min_palavras

def validar_email(texto):
    return re.match(r"^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$", texto) is not None

def validar_telefone(texto):
    return texto.isdigit() and 8 <= len(texto) <= 15

def validar_ano(texto):
    if not texto.isdigit() or len(texto) != 4:
        return False
    ano = int(texto)
    return 1900 <= ano <= 2100

def validar_nivel_idioma(nivel):
    return nivel.upper() in ['B', 'I', 'A']

def validar_mes_ano(texto):
    return re.match(r"^(0[1-9]|1[0-2])\/\d{4}$", texto) is not None or texto.upper() == 'ATUAL'

# --- PDF Personalizado ---
class PDF(FPDF):
    def header(self):
        self.set_fill_color(70, 130, 180) # SteelBlue
        self.rect(0, 0, self.w, 20, 'F')
        self.set_font('Arial', 'B', 16)
        self.set_text_color(255, 255, 255) # White
        self.cell(0, 10, 'Curr√≠culo Profissional', 0, 1, 'C')

    def footer(self):
        self.set_y(-15)
        self.set_font('Arial', 'I', 8)
        self.set_text_color(128) # Gray
        self.cell(0, 10, f'P√°gina {self.page_no()}', 0, 0, 'C')

def gerar_pdf(data):
    pdf = PDF()
    pdf.add_page()
    pdf.set_auto_page_break(auto=True, margin=15)
    pdf.set_text_color(0) # Black

    def secao(titulo):
        pdf.ln(4)
        pdf.set_font('Arial', 'B', 14)
        pdf.set_text_color(70, 130, 180) # SteelBlue
        pdf.cell(0, 12, titulo, 0, 1)
        pdf.set_text_color(0) # Black
        pdf.set_font('Arial', '', 12)

    secao("Dados Pessoais")
    pdf.cell(0, 10, f"Nome: {data.get('nome', 'N√£o informado')}", 0, 1)
    pdf.cell(0, 10, f"Idade: {data.get('idade', 'N√£o informada')}", 0, 1)
    pdf.cell(0, 10, f"Estado Civil: {data.get('estado_civil', 'N√£o informado')}", 0, 1)
    pdf.cell(0, 10, f"Telefone: {data.get('telefone', 'N√£o informado')}", 0, 1)
    pdf.cell(0, 10, f"E-mail: {data.get('email', 'N√£o informado')}", 0, 1)

    secao("Forma√ß√£o Acad√™mica")
    if data.get('forma_2grau') == 'S':
        ano_2g = data.get('ano_2grau', 'N√£o informado')
        pdf.cell(0, 10, f"Ensino M√©dio: Conclu√≠do em {ano_2g}", 0, 1)
    else:
        pdf.cell(0, 10, f"Ensino M√©dio: Incompleto", 0, 1)

    graduacoes = data.get('graduacoes', [])
    if graduacoes:
        for i, grad in enumerate(graduacoes):
            pdf.cell(0, 10, f"Gradua√ß√£o {i+1}:", 0, 1)
            pdf.cell(0, 10, f"   Universidade: {grad.get('faculdade', '')}", 0, 1)
            pdf.cell(0, 10, f"   Curso: {grad.get('curso', '')}", 0, 1)
            sit = grad.get('situacao', '')
            if sit == 'C':
                pdf.cell(0, 10, f"   Situa√ß√£o: Conclu√≠do em {grad.get('ano', '')}", 0, 1)
            else:
                pdf.cell(0, 10, f"   Situa√ß√£o: Cursando", 0, 1)
    else:
        pdf.cell(0, 10, "Nenhuma gradua√ß√£o informada.", 0, 1)

    pos_graduacoes = data.get('pos_graduacoes', [])
    if pos_graduacoes:
        for i, pos in enumerate(pos_graduacoes):
            pdf.cell(0, 10, f"P√≥s-Gradua√ß√£o {i+1}:", 0, 1)
            pdf.cell(0, 10, f"   Universidade: {pos.get('faculdade', '')}", 0, 1)
            pdf.cell(0, 10, f"   Curso: {pos.get('curso', '')}", 0, 1)
            sit = pos.get('situacao', '')
            if sit == 'C':
                pdf.cell(0, 10, f"   Situa√ß√£o: Conclu√≠do em {pos.get('ano', '')}", 0, 1)
            else:
                pdf.cell(0, 10, f"   Situa√ß√£o: Cursando", 0, 1)
    else:
        pdf.cell(0, 10, "Nenhuma p√≥s-gradua√ß√£o informada.", 0, 1)

    secao("Experi√™ncia Profissional")
    
    # Exibi√ß√£o para MEI
    if data.get('tipo_contrato') == '2':
        pdf.set_font('Arial', 'B', 12)
        pdf.cell(0, 10, "Tipo de Contrato: Microempreendedor Individual (MEI)", 0, 1)
        pdf.set_font('Arial', '', 12)
        tipos_trabalho = data.get('mei_trabalhos', '')
        if tipos_trabalho:
            pdf.set_font('Arial', 'B', 10)
            pdf.cell(0, 8, "Principais Trabalhos/Servi√ßos:", 0, 1)
            pdf.set_font('Arial', '', 10)
            for item in tipos_trabalho.split(','):
                if item.strip():
                    pdf.multi_cell(0, 6, f"- {item.strip()}", 0, 'L')
        else:
            pdf.cell(0, 10, "Nenhum tipo de trabalho MEI informado.", 0, 1)
    
    # Exibi√ß√£o para CLT (mantido o fluxo original)
    elif data.get('tipo_contrato') == '1': # tipo_contrato √© '1' (CLT)
        experiencias = data.get('experiencias', [])
        if experiencias:
            pdf.set_font('Arial', 'B', 12)
            pdf.cell(0, 10, "Tipo de Contrato: CLT", 0, 1)
            for i, exp in enumerate(experiencias):
                pdf.set_font('Arial', 'B', 12)
                pdf.cell(0, 10, f"Empresa {i+1}: {exp.get('empresa', '')}", 0, 1)
                pdf.set_font('Arial', '', 12)
                pdf.cell(0, 10, f"Cargo: {exp.get('cargo', '')}", 0, 1)
                pdf.cell(0, 10, f"Per√≠odo: {exp.get('adm', '')} a {exp.get('dem', '')}", 0, 1)
                
                atividades = exp.get('atividades', '')
                if atividades:
                    pdf.set_font('Arial', 'B', 10)
                    pdf.cell(0, 8, "Principais Atividades:", 0, 1)
                    pdf.set_font('Arial', '', 10)
                    for item in atividades.split('\n'):
                        if item.strip():
                            pdf.multi_cell(0, 6, f"- {item.strip()}", 0, 'L')
                
                resultados = exp.get('resultados', '')
                if resultados:
                    pdf.set_font('Arial', 'B', 10)
                    pdf.cell(0, 8, "Principais Resultados:", 0, 1)
                    pdf.set_font('Arial', '', 10)
                    for item in resultados.split('\n'):
                        if item.strip():
                            pdf.multi_cell(0, 6, f"- {item.strip()}", 0, 'L')
                pdf.ln(2)
        else:
            pdf.cell(0, 10, "Nenhuma experi√™ncia profissional CLT informada.", 0, 1)
    else: # Caso o usu√°rio tenha pulado a pergunta de contrato ou n√£o tenha informado experi√™ncia
        pdf.cell(0, 10, "Nenhuma experi√™ncia profissional informada.", 0, 1)


    secao("Idiomas")
    idiomas = data.get('idiomas', [])
    if idiomas:
        nivel_map = {'B': 'B√°sico', 'I': 'Intermedi√°rio', 'A': 'Avan√ßado'}
        for i, lang in enumerate(idiomas):
            pdf.cell(0, 10, f"Idioma {i+1}:", 0, 1)
            pdf.cell(0, 10, f"   Institui√ß√£o: {lang.get('instituicao', '')}", 0, 1)
            pdf.cell(0, 10, f"   Idioma: {lang.get('nome', '')}", 0, 1)
            nivel = lang.get('nivel', '').upper()
            pdf.cell(0, 10, f"   N√≠vel: {nivel_map.get(nivel, nivel)}", 0, 1)
            pdf.cell(0, 10, f"   In√≠cio: {lang.get('ini', '')}   |   Conclus√£o: {lang.get('fim', '')}", 0, 1)
            pdf.ln(1)
    else:
        pdf.cell(0, 10, "Nenhum idioma informado.", 0, 1)

    secao("Cursos Adicionais")
    cursos = data.get('cursos', '')
    if cursos:
        for item in cursos.split(','):
            pdf.cell(5)
            pdf.cell(0, 8, f"- {item.strip()}", 0, 1)
    else:
        pdf.cell(0, 8, "Nenhum curso adicional informado.", 0, 1)

    return pdf

# --- Fun√ß√µes Auxiliares Gen√©ricas para Perguntas ---

async def ask_text(update: Update, context: ContextTypes.DEFAULT_TYPE, prompt: str, field_key: str, next_state, validation_func=None, error_message: str = "Entrada inv√°lida. Tente novamente."):
    text = update.message.text.strip()

    if validation_func and not validation_func(text):
        await update.message.reply_text(f"‚ö†Ô∏è {error_message}")
        return context.user_data.get('current_state')

    # Atribui√ß√£o para campos n√£o aninhados ou que ser√£o tratados pela fun√ß√£o de etapa
    if field_key not in ['faculdade', 'curso', 'situacao', 'ano', 'empresa', 'cargo', 'adm', 'dem', 'atividades', 'resultados', 'instituicao', 'nome_idioma', 'nivel', 'ini', 'fim', 'mei_trabalhos']:
        context.user_data[field_key] = text.title() if field_key not in ['email'] else text.lower()

    await update.message.reply_text(prompt)
    context.user_data['current_state'] = next_state
    return next_state

async def ask_year(update: Update, context: ContextTypes.DEFAULT_TYPE, prompt: str, field_key: str, next_state):
    year = update.message.text.strip()
    if not validar_ano(year):
        await update.message.reply_text("‚ö†Ô∏è Ano inv√°lido. Digite o ano com 4 d√≠gitos, Ex: 2020")
        return context.user_data.get('current_state')
    
    if field_key not in ['ano_grad', 'pos_ano', 'idioma_ini', 'idioma_fim']:
        context.user_data[field_key] = year

    await update.message.reply_text(prompt)
    context.user_data['current_state'] = next_state
    return next_state

async def ask_option(update: Update, context: ContextTypes.DEFAULT_TYPE, prompt: str, field_key: str, next_state_yes, next_state_no, valid_options: list):
    response = update.message.text.strip().upper()
    if response not in valid_options:
        await update.message.reply_text(f"‚ö†Ô∏è Op√ß√£o inv√°lida. Por favor, digite {', '.join(valid_options)}.")
        return context.user_data.get('current_state')

    if field_key not in ['situacao_grad', 'situacao_pos', 'nivel_idioma']:
        context.user_data[field_key] = response
    
    if response == valid_options[0]:
        await update.message.reply_text(prompt)
        context.user_data['current_state'] = next_state_yes
        return next_state_yes
    else:
        context.user_data['current_state'] = next_state_no
        return next_state_no

# --- Fun√ß√µes do Bot ---

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    context.user_data.clear()
    await update.message.reply_text(
        "üëã Ol√°! Vamos criar seu curr√≠culo de forma simples e gratuita.\n\n"
        "Digite *S* para come√ßar ou *N* para sair.",
        parse_mode='Markdown'
    )
    context.user_data['current_state'] = ESCOLHA
    return ESCOLHA

async def escolha(update, context):
    resposta = update.message.text.strip().upper()
    if resposta != 'S':
        await update.message.reply_text("‚úÖ Processo encerrado. Use /start para come√ßar novamente.")
        return ConversationHandler.END
    await update.message.reply_text("üìå Digite seu nome completo:")
    context.user_data['current_state'] = NOME
    return NOME

async def nome(update, context):
    return await ask_text(update, context, "üéÇ Digite sua idade:", 'nome', IDADE, validar_texto, "Digite seu nome completo (m√≠nimo 2 palavras).")

async def idade(update, context):
    idade_text = update.message.text.strip()
    if not idade_text.isdigit() or not (14 <= int(idade_text) <= 99):
        await update.message.reply_text("‚ö†Ô∏è Idade inv√°lida. Digite apenas n√∫meros entre 14 e 99.")
        return IDADE
    context.user_data['idade'] = idade_text
    await update.message.reply_text("üíç Digite seu estado civil (Ex: Solteiro, Casado):")
    context.user_data['current_state'] = ESTADO_CIVIL
    return ESTADO_CIVIL

async def estado_civil(update, context):
    context.user_data['estado_civil'] = update.message.text.strip().title()
    await update.message.reply_text("üìû Digite seu telefone (somente n√∫meros):")
    context.user_data['current_state'] = TELEFONE
    return TELEFONE

async def telefone(update, context):
    tel = update.message.text.strip()
    if not validar_telefone(tel):
        await update.message.reply_text("‚ö†Ô∏è Telefone inv√°lido. Use apenas n√∫meros (8 a 15 d√≠gitos).")
        return TELEFONE
    context.user_data['telefone'] = tel
    await update.message.reply_text("üìß Digite seu e-mail:")
    context.user_data['current_state'] = EMAIL
    return EMAIL

async def email(update, context):
    email_text = update.message.text.strip()
    if not validar_email(email_text):
        await update.message.reply_text("‚ö†Ô∏è E-mail inv√°lido. Tente novamente.")
        return EMAIL
    context.user_data['email'] = email_text.lower()
    await update.message.reply_text("Voc√™ concluiu o Ensino M√©dio? Digite S para Sim ou N para N√£o:")
    context.user_data['current_state'] = FORMA_2GRAU
    return FORMA_2GRAU

async def forma_2grau(update, context):
    resposta = update.message.text.strip().upper()
    if resposta not in ['S', 'N']:
        await update.message.reply_text("‚ö†Ô∏è Por favor, digite S para Sim ou N para N√£o:")
        return FORMA_2GRAU
    context.user_data['forma_2grau'] = resposta
    if resposta == 'S':
        await update.message.reply_text("Em que ano foi conclu√≠do o Ensino M√©dio? (Ex: 2020)")
        context.user_data['current_state'] = ANO_2GRAU
        return ANO_2GRAU
    else:
        # --- ALTERA√á√ÉO: Pula Gradua√ß√£o e P√≥s-Gradua√ß√£o se Ensino M√©dio n√£o conclu√≠do ---
        context.user_data['ano_2grau'] = '' # Limpa o ano do ensino m√©dio, pois n√£o foi conclu√≠do
        context.user_data['graduacoes'] = [] # Garante que a lista de gradua√ß√µes esteja vazia
        context.user_data['pos_graduacoes'] = [] # Garante que a lista de p√≥s-gradua√ß√µes esteja vazia
        await update.message.reply_text(
            "Voc√™ √© um trabalhador CLT ou Microempreendedor Individual (MEI)?\n"
            "1 para CLT\n"
            "2 para Microempreendedor Individual"
        )
        context.user_data['current_state'] = TIPO_CONTRATO
        context.user_data['current_emp_index'] = 0
        context.user_data['experiencias'] = []
        context.user_data['mei_trabalhos'] = '' 
        return TIPO_CONTRATO
        # --- FIM DA ALTERA√á√ÉO ---

async def ano_2grau(update, context):
    ano = update.message.text.strip()
    if not validar_ano(ano):
        await update.message.reply_text("‚ö†Ô∏è Ano inv√°lido. Digite o ano com 4 d√≠gitos, Ex: 2020")
        return ANO_2GRAU
    context.user_data['ano_2grau'] = ano
    context.user_data['graduacoes'] = []
    context.user_data['pos_graduacoes'] = []
    await update.message.reply_text("Quantas gradua√ß√µes voc√™ possui? (Digite 0 para pular):")
    context.user_data['current_state'] = ASK_QTD_GRAD
    return ASK_QTD_GRAD

# --- Fun√ß√µes para Forma√ß√£o Acad√™mica (Gradua√ß√£o e P√≥s) ---

async def ask_qtd_grad(update, context):
    qtd = update.message.text.strip()
    if not qtd.isdigit() or int(qtd) < 0:
        await update.message.reply_text("‚ö†Ô∏è Quantidade inv√°lida. Digite um n√∫mero (Ex: 0, 1, 2).")
        return ASK_QTD_GRAD
    
    context.user_data['qtd_grad'] = int(qtd)
    context.user_data['current_academic_level'] = 'graduacao'
    context.user_data['current_academic_index'] = 0

    if int(qtd) > 0:
        await update.message.reply_text(f"Nome da Universidade ou Faculdade da Gradua√ß√£o {context.user_data['current_academic_index'] + 1}:")
        context.user_data['current_state'] = ASK_FACULDADE
        return ASK_FACULDADE
    else:
        await update.message.reply_text("Quantas P√≥s-Gradua√ß√µes voc√™ possui? (Digite 0 para pular):")
        context.user_data['current_state'] = ASK_QTD_POS
        return ASK_QTD_POS

async def ask_faculdade(update, context):
    text = update.message.text.strip()
    if not text:
        await update.message.reply_text("‚ö†Ô∏è Digite o nome da Universidade ou Faculdade:")
        return ASK_FACULDADE
    
    idx = context.user_data['current_academic_index']
    if idx >= len(context.user_data.get('graduacoes', [])):
        context.user_data.setdefault('graduacoes', []).append({})
    
    context.user_data['graduacoes'][idx]['faculdade'] = text.title()
    await update.message.reply_text(f"Qual √© o curso da Gradua√ß√£o {idx+1}? (Ex: Engenharia Civil)")
    context.user_data['current_state'] = ASK_CURSO
    return ASK_CURSO

async def ask_curso(update, context):
    text = update.message.text.strip()
    if not text:
        await update.message.reply_text("‚ö†Ô∏è Digite o curso:")
        return ASK_CURSO
    
    idx = context.user_data['current_academic_index']
    context.user_data['graduacoes'][idx]['curso'] = text.title()
    await update.message.reply_text(f"Situa√ß√£o da Gradua√ß√£o {idx+1}: C para Conclu√≠do, I para Incompleto (Cursando)")
    context.user_data['current_state'] = ASK_SITUACAO
    return ASK_SITUACAO

async def ask_situacao(update, context):
    sit = update.message.text.strip().upper()
    if sit not in ['C', 'I']:
        await update.message.reply_text("‚ö†Ô∏è Digite C para Conclu√≠do ou I para Incompleto (Cursando).")
        return ASK_SITUACAO
    
    idx = context.user_data['current_academic_index']
    context.user_data['graduacoes'][idx]['situacao'] = sit

    if sit == 'C':
        await update.message.reply_text(f"Em que ano foi conclu√≠da a Gradua√ß√£o {idx+1}? (Ex: 2025)")
        context.user_data['current_state'] = ASK_ANO_GRAD
        return ASK_ANO_GRAD
    else:
        context.user_data['graduacoes'][idx]['ano'] = ''
        await update.message.reply_text("Deseja adicionar outra Gradua√ß√£o? (S/N)")
        context.user_data['current_state'] = ADD_ACADEMIC_ITEM
        return ADD_ACADEMIC_ITEM

async def ask_ano_grad(update, context):
    ano = update.message.text.strip()
    if not validar_ano(ano):
        await update.message.reply_text("‚ö†Ô∏è Ano inv√°lido. Digite o ano com 4 d√≠gitos, Ex: 2025")
        return ASK_ANO_GRAD
    
    idx = context.user_data['current_academic_index']
    context.user_data['graduacoes'][idx]['ano'] = ano
    await update.message.reply_text("Deseja adicionar outra Gradua√ß√£o? (S/N)")
    context.user_data['current_state'] = ADD_ACADEMIC_ITEM
    return ADD_ACADEMIC_ITEM

async def add_academic_item(update, context):
    resposta = update.message.text.strip().upper()
    if resposta not in ['S', 'N']:
        await update.message.reply_text("‚ö†Ô∏è Op√ß√£o inv√°lida. Digite S para Sim ou N para N√£o:")
        return ADD_ACADEMIC_ITEM

    current_level = context.user_data['current_academic_level']

    if resposta == 'S':
        context.user_data['current_academic_index'] += 1
        if current_level == 'graduacao':
            if context.user_data['current_academic_index'] < context.user_data['qtd_grad']:
                await update.message.reply_text(f"Nome da Universidade ou Faculdade da Gradua√ß√£o {context.user_data['current_academic_index'] + 1}:")
                context.user_data['current_state'] = ASK_FACULDADE
                return ASK_FACULDADE
            else:
                await update.message.reply_text("Voc√™ j√° informou o n√∫mero de gradua√ß√µes que desejava.")
                await update.message.reply_text("Quantas P√≥s-Gradua√ß√µes voc√™ possui? (Digite 0 para pular):")
                context.user_data['current_state'] = ASK_QTD_POS
                return ASK_QTD_POS

        elif current_level == 'pos_graduacao':
            if context.user_data['current_academic_index'] < context.user_data['qtd_pos']:
                await update.message.reply_text(f"Nome da Universidade ou Faculdade da P√≥s-Gradua√ß√£o {context.user_data['current_academic_index'] + 1}:")
                context.user_data['current_state'] = ASK_POS_FACULDADE
                return ASK_POS_FACULDADE
            else:
                await update.message.reply_text("Voc√™ j√° informou o n√∫mero de p√≥s-gradua√ß√µes que desejava.")
                await update.message.reply_text(
                    "Voc√™ √© um trabalhador CLT ou Microempreendedor Individual (MEI)?\n"
                    "1 para CLT\n"
                    "2 para Microempreendedor Individual"
                )
                context.user_data['current_state'] = TIPO_CONTRATO
                context.user_data['current_emp_index'] = 0
                context.user_data['experiencias'] = []
                context.user_data['mei_trabalhos'] = '' 
                return TIPO_CONTRATO
    else: # Resposta 'N'
        if current_level == 'graduacao':
            await update.message.reply_text("Quantas P√≥s-Gradua√ß√µes voc√™ possui? (Digite 0 para pular):")
            context.user_data['current_state'] = ASK_QTD_POS
            return ASK_QTD_POS
        elif current_level == 'pos_graduacao':
            await update.message.reply_text(
                "Voc√™ √© um trabalhador CLT ou Microempreendedor Individual (MEI)?\n"
                "1 para CLT\n"
                "2 para Microempreendedor Individual"
            )
            context.user_data['current_state'] = TIPO_CONTRATO
            context.user_data['current_emp_index'] = 0
            context.user_data['experiencias'] = []
            context.user_data['mei_trabalhos'] = '' 
            return TIPO_CONTRATO

# Fun√ß√µes para P√≥s-Gradua√ß√£o
async def ask_qtd_pos(update, context):
    qtd = update.message.text.strip()
    if not qtd.isdigit() or int(qtd) < 0:
        await update.message.reply_text("‚ö†Ô∏è Quantidade inv√°lida. Digite um n√∫mero (Ex: 0, 1, 2).")
        return ASK_QTD_POS
    
    context.user_data['qtd_pos'] = int(qtd)
    context.user_data['current_academic_level'] = 'pos_graduacao'
    context.user_data['current_academic_index'] = 0

    if int(qtd) > 0:
        await update.message.reply_text(f"Nome da Universidade ou Faculdade da P√≥s-Gradua√ß√£o {context.user_data['current_academic_index'] + 1}:")
        context.user_data['current_state'] = ASK_POS_FACULDADE
        return ASK_POS_FACULDADE
    else:
        await update.message.reply_text(
            "Voc√™ √© um trabalhador CLT ou Microempreendedor Individual (MEI)?\n"
            "1 para CLT\n"
            "2 para Microempreendedor Individual"
        )
        context.user_data['current_state'] = TIPO_CONTRATO
        context.user_data['current_emp_index'] = 0
        context.user_data['experiencias'] = []
        context.user_data['mei_trabalhos'] = '' 
        return TIPO_CONTRATO

async def ask_pos_faculdade(update, context):
    text = update.message.text.strip()
    if not text:
        await update.message.reply_text("‚ö†Ô∏è Digite o nome da Universidade ou Faculdade:")
        return ASK_POS_FACULDADE
    
    idx = context.user_data['current_academic_index']
    if idx >= len(context.user_data.get('pos_graduacoes', [])):
        context.user_data.setdefault('pos_graduacoes', []).append({})
    
    context.user_data['pos_graduacoes'][idx]['faculdade'] = text.title()
    await update.message.reply_text(f"Qual √© o curso da P√≥s-Gradua√ß√£o {idx+1}? (Ex: MBA em Gest√£o)")
    context.user_data['current_state'] = ASK_POS_CURSO
    return ASK_POS_CURSO

async def ask_pos_curso(update, context):
    text = update.message.text.strip()
    if not text:
        await update.message.reply_text("‚ö†Ô∏è Digite o curso:")
        return ASK_POS_CURSO
    
    idx = context.user_data['current_academic_index']
    context.user_data['pos_graduacoes'][idx]['curso'] = text.title()
    await update.message.reply_text(f"Situa√ß√£o da P√≥s-Gradua√ß√£o {idx+1}: C para Conclu√≠do, I para Incompleto (Cursando)")
    context.user_data['current_state'] = ASK_POS_SITUACAO
    return ASK_POS_SITUACAO

async def ask_pos_situacao(update, context):
    sit = update.message.text.strip().upper()
    if sit not in ['C', 'I']:
        await update.message.reply_text("‚ö†Ô∏è Digite C para Conclu√≠do ou I para Incompleto (Cursando).")
        return ASK_POS_SITUACAO
    
    idx = context.user_data['current_academic_index']
    context.user_data['pos_graduacoes'][idx]['situacao'] = sit

    if sit == 'C':
        await update.message.reply_text(f"Em que ano foi conclu√≠da a P√≥s-Gradua√ß√£o {idx+1}? (Ex: 2025)")
        context.user_data['current_state'] = ASK_POS_ANO
        return ASK_POS_ANO
    else:
        context.user_data['pos_graduacoes'][idx]['ano'] = ''
        await update.message.reply_text("Deseja adicionar outra P√≥s-Gradua√ß√£o? (S/N)")
        context.user_data['current_state'] = ADD_ACADEMIC_ITEM
        return ADD_ACADEMIC_ITEM

async def ask_pos_ano(update, context):
    ano = update.message.text.strip()
    if not validar_ano(ano):
        await update.message.reply_text("‚ö†Ô∏è Ano inv√°lido. Digite o ano com 4 d√≠gitos, Ex: 2025")
        return ASK_POS_ANO
    
    idx = context.user_data['current_academic_index']
    context.user_data['pos_graduacoes'][idx]['ano'] = ano
    await update.message.reply_text("Deseja adicionar outra P√≥s-Gradua√ß√£o? (S/N)")
    context.user_data['current_state'] = ADD_ACADEMIC_ITEM
    return ADD_ACADEMIC_ITEM

# --- Fun√ß√µes para Experi√™ncia Profissional ---

async def tipo_contrato(update, context):
    resposta = update.message.text.strip()
    
    if resposta == '1': # CLT
        context.user_data['tipo_contrato'] = '1'
        context.user_data['experiencias'] = [] 
        await update.message.reply_text("üè¢ Nome da √∫ltima empresa trabalhada (ou digite 'N' para pular):")
        context.user_data['current_state'] = EMPRESA
        context.user_data['current_emp_index'] = 0
        return EMPRESA
    elif resposta == '2': # MEI
        context.user_data['tipo_contrato'] = '2'
        await update.message.reply_text(
            "Liste o tipo de trabalho que voc√™ realiza como MEI (separando por v√≠rgula).\n"
            "Ex: Desenvolvedor Web, Consultor de Marketing, Designer Gr√°fico"
        )
        context.user_data['current_state'] = MEI_TRABALHOS
        context.user_data['experiencias'] = [] 
        return MEI_TRABALHOS
    else:
        await update.message.reply_text("‚ö†Ô∏è Op√ß√£o inv√°lida. Digite 1 para CLT ou 2 para Microempreendedor Individual.")
        return TIPO_CONTRATO

async def mei_trabalhos(update, context):
    text = update.message.text.strip()
    context.user_data['mei_trabalhos'] = text
    await update.message.reply_text("Voc√™ possui cursos de idiomas? Digite S para Sim ou N para N√£o:")
    context.user_data['current_state'] = IDIOMAS_SIM
    context.user_data['current_idioma_index'] = 0
    context.user_data['idiomas'] = []
    return IDIOMAS_SIM

async def empresa(update, context):
    text = update.message.text.strip()
    if text.upper() == 'N':
        await update.message.reply_text("Voc√™ possui cursos de idiomas? Digite S para Sim ou N para N√£o:")
        context.user_data['current_state'] = IDIOMAS_SIM
        context.user_data['current_idioma_index'] = 0
        context.user_data['idiomas'] = []
        return IDIOMAS_SIM
    
    if not text:
        await update.message.reply_text("‚ö†Ô∏è Digite o nome da empresa ou 'N' para pular.")
        return EMPRESA

    idx = context.user_data['current_emp_index']
    if idx >= len(context.user_data.get('experiencias', [])):
        context.user_data.setdefault('experiencias', []).append({})
    
    context.user_data['experiencias'][idx]['empresa'] = text.title()
    await update.message.reply_text(f"Cargo exercido na {text.title()}:")
    context.user_data['current_state'] = CARGO
    return CARGO

async def cargo(update, context):
    text = update.message.text.strip()
    if not text:
        await update.message.reply_text("‚ö†Ô∏è Digite o cargo exercido:")
        return CARGO

    idx = context.user_data['current_emp_index']
    context.user_data['experiencias'][idx]['cargo'] = text.title()
    await update.message.reply_text("Data de admiss√£o (Ex: 01/2020):")
    context.user_data['current_state'] = ADM
    return ADM

async def adm(update, context):
    text = update.message.text.strip()
    if not validar_mes_ano(text):
        await update.message.reply_text("‚ö†Ô∏è Data inv√°lida. Use MM/YYYY ou 'Atual'.")
        return ADM
    
    idx = context.user_data['current_emp_index']
    context.user_data['experiencias'][idx]['adm'] = text
    await update.message.reply_text("Data de demiss√£o ou sa√≠da (Ex: 12/2022 ou Atual):")
    context.user_data['current_state'] = DEM
    return DEM

async def dem(update, context):
    text = update.message.text.strip()
    if not validar_mes_ano(text):
        await update.message.reply_text("‚ö†Ô∏è Data inv√°lida. Use MM/YYYY ou 'Atual'.")
        return DEM
    
    idx = context.user_data['current_emp_index']
    context.user_data['experiencias'][idx]['dem'] = text
    
    await update.message.reply_text(
        "Liste suas principais atividades e responsabilidades (uma por linha, ou separadas por ';').\n"
        "Exemplo:\n"
        "- Gest√£o de projetos\n"
        "- Desenvolvimento de software\n"
        "Ou digite 'N' para pular."
    )
    context.user_data['current_state'] = ATIVIDADES
    return ATIVIDADES

async def atividades(update, context):
    text = update.message.text.strip()
    idx = context.user_data['current_emp_index']
    
    if text.upper() == 'N':
        context.user_data['experiencias'][idx]['atividades'] = ''
    else:
        context.user_data['experiencias'][idx]['atividades'] = text.replace(';', '\n')

    await update.message.reply_text(
        "Liste seus principais resultados ou conquistas (uma por linha, ou separadas por ';').\n"
        "Exemplo:\n"
        "- Redu√ß√£o de custos em 15%\n"
        "- Aumento de vendas em 20%\n"
        "Ou digite 'N' para pular."
    )
    context.user_data['current_state'] = RESULTADOS
    return RESULTADOS

async def resultados(update, context):
    text = update.message.text.strip()
    idx = context.user_data['current_emp_index']

    if text.upper() == 'N':
        context.user_data['experiencias'][idx]['resultados'] = ''
    else:
        context.user_data['experiencias'][idx]['resultados'] = text.replace(';', '\n')
        
    await update.message.reply_text("Deseja adicionar outra Experi√™ncia Profissional? (S/N)")
    context.user_data['current_state'] = ADD_EMP
    return ADD_EMP

async def add_emp(update, context):
    resposta = update.message.text.strip().upper()
    if resposta not in ['S', 'N']:
        await update.message.reply_text("‚ö†Ô∏è Op√ß√£o inv√°lida. Digite S para Sim ou N para N√£o:")
        return ADD_EMP
    
    if resposta == 'S':
        context.user_data['current_emp_index'] += 1
        await update.message.reply_text(f"Nome da pr√≥xima empresa (Experi√™ncia {context.user_data['current_emp_index'] + 1}):")
        context.user_data['current_state'] = EMPRESA
        return EMPRESA
    else:
        await update.message.reply_text("Voc√™ possui cursos de idiomas? Digite S para Sim ou N para N√£o:")
        context.user_data['current_state'] = IDIOMAS_SIM
        context.user_data['current_idioma_index'] = 0
        context.user_data['idiomas'] = []
        return IDIOMAS_SIM

# --- Fun√ß√µes para Idiomas ---
async def idiomas_sim(update, context):
    resposta = update.message.text.strip().upper()
    if resposta not in ['S', 'N']:
        await update.message.reply_text("‚ö†Ô∏è Responda S para Sim ou N para N√£o:")
        return IDIOMAS_SIM

    if resposta == 'N':
        await update.message.reply_text("üìö Liste seus cursos adicionais separados por v√≠rgula (Ex: Java, JavaScript, Excel):")
        context.user_data['current_state'] = CURSOS
        return CURSOS
    else:
        context.user_data['current_idioma_index'] = 0
        context.user_data['idiomas'] = []
        await update.message.reply_text(f"Institui√ß√£o do idioma {context.user_data['current_idioma_index'] + 1}:")
        context.user_data['current_state'] = ASK_IDIOMA_INST
        return ASK_IDIOMA_INST

async def ask_idioma_inst(update, context):
    text = update.message.text.strip()
    if not text:
        await update.message.reply_text("‚ö†Ô∏è Digite o nome da institui√ß√£o do idioma:")
        return ASK_IDIOMA_INST
    
    idx = context.user_data['current_idioma_index']
    if idx >= len(context.user_data.get('idiomas', [])):
        context.user_data.setdefault('idiomas', []).append({})
    
    context.user_data['idiomas'][idx]['instituicao'] = text.title() # CORRE√á√ÉO AQUI
    await update.message.reply_text(f"Qual o nome do idioma {idx+1}? (Ex: Ingl√™s, Espanhol)")
    context.user_data['current_state'] = ASK_IDIOMA_NOME
    return ASK_IDIOMA_NOME

async def ask_idioma_nome(update, context):
    text = update.message.text.strip()
    if not text:
        await update.message.reply_text("‚ö†Ô∏è Digite o nome do idioma:")
        return ASK_IDIOMA_NOME
    
    idx = context.user_data['current_idioma_index']
    context.user_data['idiomas'][idx]['nome'] = text.title()
    await update.message.reply_text(f"Qual o n√≠vel do idioma {idx+1}? (B para B√°sico, I para Intermedi√°rio, A para Avan√ßado)")
    context.user_data['current_state'] = ASK_IDIOMA_NIVEL
    return ASK_IDIOMA_NIVEL

async def ask_idioma_nivel(update, context):
    nivel = update.message.text.strip().upper()
    if not validar_nivel_idioma(nivel):
        await update.message.reply_text("‚ö†Ô∏è N√≠vel inv√°lido. Digite B, I ou A.")
        return ASK_IDIOMA_NIVEL
    
    idx = context.user_data['current_idioma_index']
    context.user_data['idiomas'][idx]['nivel'] = nivel
    await update.message.reply_text(f"Data de in√≠cio do idioma {idx+1} (MM/YYYY):")
    context.user_data['current_state'] = ASK_IDIOMA_INI
    return ASK_IDIOMA_INI

async def ask_idioma_ini(update, context):
    text = update.message.text.strip()
    if not validar_mes_ano(text):
        await update.message.reply_text("‚ö†Ô∏è Data inv√°lida. Use MM/YYYY ou 'Atual'.")
        return ASK_IDIOMA_INI
    
    idx = context.user_data['current_idioma_index']
    context.user_data['idiomas'][idx]['ini'] = text
    await update.message.reply_text(f"Data de conclus√£o do idioma {idx+1} (MM/YYYY ou 'Atual'):")
    context.user_data['current_state'] = ASK_IDIOMA_FIM
    return ASK_IDIOMA_FIM

async def ask_idioma_fim(update, context):
    text = update.message.text.strip()
    if not validar_mes_ano(text):
        await update.message.reply_text("‚ö†Ô∏è Data inv√°lida. Use MM/YYYY ou 'Atual'.")
        return ASK_IDIOMA_FIM
    
    idx = context.user_data['current_idioma_index']
    context.user_data['idiomas'][idx]['fim'] = text
    await update.message.reply_text("Deseja adicionar outro idioma? (S/N)")
    context.user_data['current_state'] = ADD_IDIOMA
    return ADD_IDIOMA

async def add_idioma(update, context):
    resposta = update.message.text.strip().upper()
    if resposta not in ['S', 'N']:
        await update.message.reply_text("‚ö†Ô∏è Op√ß√£o inv√°lida. Digite S para Sim ou N para N√£o:")
        return ADD_IDIOMA
    
    if resposta == 'S':
        context.user_data['current_idioma_index'] += 1
        await update.message.reply_text(f"Institui√ß√£o do idioma {context.user_data['current_idioma_index'] + 1}:")
        context.user_data['current_state'] = ASK_IDIOMA_INST
        return ASK_IDIOMA_INST
    else:
        await update.message.reply_text("üìö Liste seus cursos adicionais separados por v√≠rgula (Ex: Java, JavaScript, Excel):")
        context.user_data['current_state'] = CURSOS
        return CURSOS

# --- Fun√ß√µes para Cursos Adicionais e Finaliza√ß√£o ---
async def cursos(update, context):
    text = update.message.text.strip()
    context.user_data['cursos'] = text
    await update.message.reply_text("‚úÖ √ìtimo! Coletamos todas as informa√ß√µes. Deseja gerar o curr√≠culo em PDF? (S/N)")
    context.user_data['current_state'] = REINICIAR
    return REINICIAR

async def reiniciar(update, context):
    resposta = update.message.text.strip().upper()
    if resposta == 'S':
        pdf = gerar_pdf(context.user_data)
        buf = io.BytesIO()
        pdf.output(buf, 'F')
        buf.seek(0)
        await update.message.reply_document(buf, filename="curriculo.pdf")
        await update.message.reply_text("Seu curr√≠culo foi gerado com sucesso! Use /start para criar um novo ou /cancel para encerrar.")
        return ConversationHandler.END
    elif resposta == 'N':
        await update.message.reply_text("‚úÖ Processo encerrado. Use /start para come√ßar novamente.")
        return ConversationHandler.END
    else:
        await update.message.reply_text("‚ö†Ô∏è Op√ß√£o inv√°lida. Digite S para Sim ou N para N√£o.")
        return REINICIAR

async def cancel(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    await update.message.reply_text(
        "‚ùå Conversa cancelada. Use /start para come√ßar novamente."
    )
    context.user_data.clear()
    return ConversationHandler.END

def main():
    application = ApplicationBuilder().token("7501669528:AAGMiGmscYFhhnSwGsENZlu1kcauoVI-UIM").build() # Substitua pelo seu token

    conv_handler = ConversationHandler(
        entry_points=[CommandHandler("start", start)],
        states={
            ESCOLHA: [MessageHandler(filters.TEXT & ~filters.COMMAND, escolha)],
            NOME: [MessageHandler(filters.TEXT & ~filters.COMMAND, nome)],
            IDADE: [MessageHandler(filters.TEXT & ~filters.COMMAND, idade)],
            ESTADO_CIVIL: [MessageHandler(filters.TEXT & ~filters.COMMAND, estado_civil)],
            TELEFONE: [MessageHandler(filters.TEXT & ~filters.COMMAND, telefone)],
            EMAIL: [MessageHandler(filters.TEXT & ~filters.COMMAND, email)],
            FORMA_2GRAU: [MessageHandler(filters.TEXT & ~filters.COMMAND, forma_2grau)],
            ANO_2GRAU: [MessageHandler(filters.TEXT & ~filters.COMMAND, ano_2grau)],

            ASK_QTD_GRAD: [MessageHandler(filters.TEXT & ~filters.COMMAND, ask_qtd_grad)],
            ASK_FACULDADE: [MessageHandler(filters.TEXT & ~filters.COMMAND, ask_faculdade)],
            ASK_CURSO: [MessageHandler(filters.TEXT & ~filters.COMMAND, ask_curso)],
            ASK_SITUACAO: [MessageHandler(filters.TEXT & ~filters.COMMAND, ask_situacao)],
            ASK_ANO_GRAD: [MessageHandler(filters.TEXT & ~filters.COMMAND, ask_ano_grad)],
            ADD_ACADEMIC_ITEM: [MessageHandler(filters.TEXT & ~filters.COMMAND, add_academic_item)],

            ASK_QTD_POS: [MessageHandler(filters.TEXT & ~filters.COMMAND, ask_qtd_pos)],
            ASK_POS_FACULDADE: [MessageHandler(filters.TEXT & ~filters.COMMAND, ask_pos_faculdade)],
            ASK_POS_CURSO: [MessageHandler(filters.TEXT & ~filters.COMMAND, ask_pos_curso)],
            ASK_POS_SITUACAO: [MessageHandler(filters.TEXT & ~filters.COMMAND, ask_pos_situacao)],
            ASK_POS_ANO: [MessageHandler(filters.TEXT & ~filters.COMMAND, ask_pos_ano)],
            
            TIPO_CONTRATO: [MessageHandler(filters.TEXT & ~filters.COMMAND, tipo_contrato)],
            MEI_TRABALHOS: [MessageHandler(filters.TEXT & ~filters.COMMAND, mei_trabalhos)],
            EMPRESA: [MessageHandler(filters.TEXT & ~filters.COMMAND, empresa)],
            CARGO: [MessageHandler(filters.TEXT & ~filters.COMMAND, cargo)],
            ADM: [MessageHandler(filters.TEXT & ~filters.COMMAND, adm)],
            DEM: [MessageHandler(filters.TEXT & ~filters.COMMAND, dem)],
            ATIVIDADES: [MessageHandler(filters.TEXT & ~filters.COMMAND, atividades)],
            RESULTADOS: [MessageHandler(filters.TEXT & ~filters.COMMAND, resultados)],
            ADD_EMP: [MessageHandler(filters.TEXT & ~filters.COMMAND, add_emp)],

            IDIOMAS_SIM: [MessageHandler(filters.TEXT & ~filters.COMMAND, idiomas_sim)],
            ASK_IDIOMA_INST: [MessageHandler(filters.TEXT & ~filters.COMMAND, ask_idioma_inst)],
            ASK_IDIOMA_NOME: [MessageHandler(filters.TEXT & ~filters.COMMAND, ask_idioma_nome)],
            ASK_IDIOMA_NIVEL: [MessageHandler(filters.TEXT & ~filters.COMMAND, ask_idioma_nivel)],
            ASK_IDIOMA_INI: [MessageHandler(filters.TEXT & ~filters.COMMAND, ask_idioma_ini)],
            ASK_IDIOMA_FIM: [MessageHandler(filters.TEXT & ~filters.COMMAND, ask_idioma_fim)],
            ADD_IDIOMA: [MessageHandler(filters.TEXT & ~filters.COMMAND, add_idioma)],

            CURSOS: [MessageHandler(filters.TEXT & ~filters.COMMAND, cursos)],
            REINICIAR: [MessageHandler(filters.TEXT & ~filters.COMMAND, reiniciar)],
        },
        fallbacks=[CommandHandler("cancel", cancel)],
    )

    application.add_handler(conv_handler)
    application.run_polling()

if __name__ == "__main__":
    main()
 
 
 
